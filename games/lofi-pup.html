<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedural Lofi Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@300;400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            user-select: none;
        }

        .retro-text {
            font-family: 'VT323', monospace;
        }

        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* Gentle pulse animation for the speakers */
        @keyframes pulse-speaker {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .bumping {
            animation: pulse-speaker 0.4s ease-out;
        }

        .station-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            color: #78716c;
            /* stone-500 */
        }

        .station-btn:hover {
            color: #d97706;
            /* amber-600 */
        }

        .station-btn.active {
            background-color: rgba(68, 64, 60, 0.5);
            /* stone-700/50 */
            color: #d97706;
            /* amber-600 */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .mixer-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            background-color: rgba(41, 37, 36, 0.4);
            /* stone-900/40 */
            color: #78716c;
            /* stone-500 */
        }

        .mixer-btn.active {
            border-color: rgba(120, 113, 108, 0.2);
            background-color: rgba(68, 64, 60, 0.5);
            /* stone-700/50 */
            color: #d97706;
            /* amber-600 */
        }

        /* Vertical range slider styling */
        .vertical-range {
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            writing-mode: bt-lr;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .vertical-range:hover {
            opacity: 1;
        }
    </style>
</head>

<body
    class="h-screen w-screen overflow-hidden flex flex-col items-center justify-center text-stone-300 relative bg-stone-900">

    <!-- Background Ambience -->
    <div
        class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMWExYTFhIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMyMzIzMjMiLz4KPC9zdmc+')] opacity-50 z-0">
    </div>
    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-stone-900 z-0 opacity-80"></div>

    <!-- Main Player Container -->
    <div class="relative z-10 w-full max-w-md p-6">

        <!-- Tape Deck Visual -->
        <div
            class="bg-stone-800 rounded-lg shadow-2xl border-t border-stone-700 p-6 flex flex-col gap-6 relative overflow-hidden">
            <!-- decorative screws -->
            <div class="absolute top-2 left-2 w-2 h-2 rounded-full bg-stone-600"></div>
            <div class="absolute top-2 right-2 w-2 h-2 rounded-full bg-stone-600"></div>
            <div class="absolute bottom-2 left-2 w-2 h-2 rounded-full bg-stone-600"></div>
            <div class="absolute bottom-2 right-2 w-2 h-2 rounded-full bg-stone-600"></div>

            <!-- Screen / Visualizer -->
            <div
                class="bg-black border-4 border-stone-700 rounded-md h-32 relative flex items-center justify-center overflow-hidden group">
                <canvas id="visualizer" class="absolute inset-0 w-full h-full opacity-60"></canvas>
                <div class="crt-overlay absolute inset-0 z-20"></div>
                <div id="status-text" class="retro-text text-amber-500 text-2xl z-30 tracking-widest animate-pulse">
                    Ready...</div>

                <!-- Cassette Wheels Animation (Pure CSS) -->
                <div id="tape-wheels"
                    class="absolute inset-0 flex justify-center items-center gap-12 opacity-0 transition-opacity duration-500">
                    <div
                        class="w-16 h-16 border-4 border-stone-600 rounded-full flex items-center justify-center animate-[spin_4s_linear_infinite]">
                        <div class="w-2 h-2 bg-white rounded-full"></div>
                        <div class="absolute w-full h-1 bg-stone-800"></div>
                        <div class="absolute w-1 h-full bg-stone-800"></div>
                    </div>
                    <div
                        class="w-16 h-16 border-4 border-stone-600 rounded-full flex items-center justify-center animate-[spin_4s_linear_infinite]">
                        <div class="w-2 h-2 bg-white rounded-full"></div>
                        <div class="absolute w-full h-1 bg-stone-800"></div>
                        <div class="absolute w-1 h-full bg-stone-800"></div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col gap-4">

                <!-- Station Selector -->
                <div class="flex justify-between items-center bg-stone-900/40 p-2 rounded-2xl mb-2">
                    <button onclick="switchStation('sunset')" id="btn-sunset" class="station-btn active group">
                        <i data-lucide="sun" class="w-4 h-4"></i>
                        <span class="text-[8px] font-black uppercase tracking-tighter">Sunset</span>
                    </button>
                    <button onclick="switchStation('rainy')" id="btn-rainy" class="station-btn group">
                        <i data-lucide="cloud-rain" class="w-4 h-4"></i>
                        <span class="text-[8px] font-black uppercase tracking-tighter">Rainy</span>
                    </button>
                    <button onclick="switchStation('midnight')" id="btn-midnight" class="station-btn group">
                        <i data-lucide="moon" class="w-4 h-4"></i>
                        <span class="text-[8px] font-black uppercase tracking-tighter">Midnight</span>
                    </button>
                </div>

                <!-- Mixer -->
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <!-- Kick Column -->
                    <div class="flex flex-col gap-2 items-center">
                        <div class="h-16 w-full bg-stone-900/40 rounded-xl flex items-center justify-center p-2">
                            <input type="range" oninput="updateMixerVolume('kick', this.value)" min="0" max="100"
                                value="80" class="vertical-range h-12 w-1 accent-amber-600 cursor-pointer"
                                style="-webkit-appearance: slider-vertical; appearance: slider-vertical;">
                        </div>
                        <button onclick="toggleInstrument('kick')" id="mix-kick"
                            class="mixer-btn active group flex-col gap-1 py-1 w-full" title="Toggle Kick">
                            <i data-lucide="circle-dot" class="w-3 h-3"></i>
                            <span class="text-[7px] font-black uppercase">Kick</span>
                        </button>
                    </div>

                    <!-- Snare Column -->
                    <div class="flex flex-col gap-2 items-center">
                        <div class="h-16 w-full bg-stone-900/40 rounded-xl flex items-center justify-center p-2">
                            <input type="range" oninput="updateMixerVolume('snare', this.value)" min="0" max="100"
                                value="70" class="vertical-range h-12 w-1 accent-amber-600 cursor-pointer"
                                style="-webkit-appearance: slider-vertical; appearance: slider-vertical;">
                        </div>
                        <button onclick="toggleInstrument('snare')" id="mix-snare"
                            class="mixer-btn active group flex-col gap-1 py-1 w-full" title="Toggle Snare">
                            <i data-lucide="circle" class="w-3 h-3"></i>
                            <span class="text-[7px] font-black uppercase">Snare</span>
                        </button>
                    </div>

                    <!-- Hats Column -->
                    <div class="flex flex-col gap-2 items-center">
                        <div class="h-16 w-full bg-stone-900/40 rounded-xl flex items-center justify-center p-2">
                            <input type="range" oninput="updateMixerVolume('hihat', this.value)" min="0" max="100"
                                value="80" class="vertical-range h-12 w-1 accent-amber-600 cursor-pointer"
                                style="-webkit-appearance: slider-vertical; appearance: slider-vertical;">
                        </div>
                        <button onclick="toggleInstrument('hihat')" id="mix-hihat"
                            class="mixer-btn active group flex-col gap-1 py-1 w-full" title="Toggle Hi-Hat">
                            <i data-lucide="more-horizontal" class="w-3 h-3"></i>
                            <span class="text-[7px] font-black uppercase">Hats</span>
                        </button>
                    </div>

                    <!-- Chord Column -->
                    <div class="flex flex-col gap-2 items-center">
                        <div class="h-16 w-full bg-stone-900/40 rounded-xl flex items-center justify-center p-2">
                            <input type="range" oninput="updateMixerVolume('chord', this.value)" min="0" max="100"
                                value="70" class="vertical-range h-12 w-1 accent-amber-600 cursor-pointer"
                                style="-webkit-appearance: slider-vertical; appearance: slider-vertical;">
                        </div>
                        <button onclick="toggleInstrument('chord')" id="mix-chord"
                            class="mixer-btn active group flex-col gap-1 py-1 w-full" title="Toggle Chords">
                            <i data-lucide="layers" class="w-3 h-3"></i>
                            <span class="text-[7px] font-black uppercase">Chord</span>
                        </button>
                    </div>
                </div>

                <!-- Main Transport -->
                <div class="flex justify-center items-center gap-6">
                    <button id="play-btn"
                        class="w-16 h-16 rounded-full bg-amber-600 hover:bg-amber-500 text-stone-900 flex items-center justify-center shadow-lg transition-all active:scale-95 group">
                        <i data-lucide="play" class="w-8 h-8 fill-current group-[.playing]:hidden"></i>
                        <i data-lucide="square" class="w-6 h-6 fill-current hidden group-[.playing]:block"></i>
                    </button>
                </div>

                <!-- Sliders -->
                <div class="grid grid-cols-1 gap-4 mt-2">
                    <div class="space-y-1">
                        <div
                            class="flex justify-between text-xs font-bold tracking-wider text-stone-500 uppercase items-center">
                            <div class="flex items-center gap-1">
                                <span>Lofi Filter</span>
                                <button onclick="showHelp('filter')" class="hover:text-amber-600 transition-colors">
                                    <i data-lucide="help-circle" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <span id="filter-val">50%</span>
                        </div>
                        <input type="range" id="filter-slider" min="100" max="3000" value="800"
                            class="w-full h-2 bg-stone-900 rounded-lg appearance-none cursor-pointer accent-amber-600">
                    </div>

                    <div class="space-y-1">
                        <div
                            class="flex justify-between text-xs font-bold tracking-wider text-stone-500 uppercase items-center">
                            <div class="flex items-center gap-1">
                                <span>Vinyl Crackle</span>
                                <button onclick="showHelp('crackle')" class="hover:text-amber-600 transition-colors">
                                    <i data-lucide="help-circle" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <span id="crackle-val">30%</span>
                        </div>
                        <input type="range" id="crackle-slider" min="0" max="100" value="15"
                            class="w-full h-2 bg-stone-900 rounded-lg appearance-none cursor-pointer accent-amber-600">
                    </div>

                    <div class="space-y-1">
                        <div
                            class="flex justify-between text-xs font-bold tracking-wider text-stone-500 uppercase items-center">
                            <div class="flex items-center gap-1">
                                <span>Tape Wobble</span>
                                <button onclick="showHelp('wobble')" class="hover:text-amber-600 transition-colors">
                                    <i data-lucide="help-circle" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <span id="wobble-val">Medium</span>
                        </div>
                        <input type="range" id="wobble-slider" min="0" max="50" value="15"
                            class="w-full h-2 bg-stone-900 rounded-lg appearance-none cursor-pointer accent-amber-600">
                    </div>

                    <!-- Meta Info -->
                    <div class="text-center mt-2 flex flex-col items-center gap-1">
                        <div
                            class="flex items-center gap-1 text-[10px] font-bold tracking-widest text-stone-600 uppercase">
                            <span>Now Playing</span>
                            <button onclick="showHelp('chord')" class="hover:text-amber-600 transition-colors">
                                <i data-lucide="help-circle" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <p id="chord-display" class="text-stone-500 text-sm h-5 font-mono">--</p>
                    </div>
                </div>
            </div>

            <p class="text-center text-stone-600 text-xs mt-6">
                Generative Audio Engine | Web Audio API<br>
                No Samples Used
            </p>

            <!-- Help Modal -->
            <div id="help-modal"
                class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4">
                <div class="bg-stone-900/90 border border-stone-800 p-6 rounded-2xl max-w-md w-full shadow-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <h3 id="help-title" class="text-amber-600 font-bold uppercase tracking-widest text-lg">Help</h3>
                        <button onclick="hideHelp()" class="text-stone-500 hover:text-white transition-colors">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div id="help-content" class="space-y-4 text-stone-300 text-sm leading-relaxed">
                        <!-- Content injected here -->
                    </div>
                    <button onclick="hideHelp()"
                        class="mt-8 w-full py-3 bg-stone-800 hover:bg-stone-700 text-white font-bold rounded-xl transition-all uppercase tracking-widest text-xs">
                        Got it
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Init Icons
            lucide.createIcons();

            // Audio Context
            let audioCtx;
            let isPlaying = false;
            let nextNoteTime = 0.0;
            let timerID;
            let beatCount = 0;

            // Nodes
            let masterGain;
            let compressor;
            let vinylGain;
            let vinylNode;
            let analyser;

            // Mixer Group Nodes
            let mixKick, mixSnare, mixHihat, mixChord;

            // Settings
            const lookahead = 25.0; // ms
            const scheduleAheadTime = 0.1; // s
            let bpm = 80;

            // Station Data
            const stations = {
                sunset: {
                    name: "Sunset Glow",
                    bpm: 80,
                    style: "classic",
                    color: "text-amber-600"
                },
                rainy: {
                    name: "Rainy Window",
                    bpm: 72,
                    style: "minimal",
                    color: "text-blue-500"
                },
                midnight: {
                    name: "Midnight Neon",
                    bpm: 92,
                    style: "jazzy",
                    color: "text-purple-500"
                }
            };
            let currentStation = 'sunset';

            // Mixer State
            let instrumentState = {
                kick: true,
                snare: true,
                hihat: true,
                chord: true
            };
            let instrumentVolumes = {
                kick: 0.8,
                snare: 0.7,
                hihat: 0.8,
                chord: 0.7
            };

            // Canvas
            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');

            // UI Elements
            const playBtn = document.getElementById('play-btn');
            const statusText = document.getElementById('status-text');
            const tapeWheels = document.getElementById('tape-wheels');
            const filterSlider = document.getElementById('filter-slider');
            const crackleSlider = document.getElementById('crackle-slider');
            const wobbleSlider = document.getElementById('wobble-slider');
            const chordDisplay = document.getElementById('chord-display');

            // Music Theory Data (Jazzy/Lofi Chords)
            // Root notes relative to C (0)
            // Structures: 0=Root, 3=Min3, 4=Maj3, 7=Perf5, 10=Min7, 11=Maj7, 14=9
            const chords = [
                { name: "Cmaj9", offsets: [48, 52, 55, 59, 62] },
                { name: "Am9", offsets: [45, 48, 52, 55, 59] },
                { name: "Dm9", offsets: [50, 53, 57, 60, 64] },
                { name: "G13", offsets: [55, 59, 62, 65, 69] },
                { name: "Cmaj9_2", offsets: [48, 52, 55, 59, 62] },
                { name: "Am11", offsets: [57, 60, 64, 67, 71] },
                { name: "Fmaj7", offsets: [53, 57, 60, 64] },
                { name: "Em7", offsets: [52, 55, 59, 62] },
                { name: "Ebmaj7", offsets: [51, 55, 58, 62] },
                { name: "Abmaj7", offsets: [56, 60, 63, 67] }
            ];

            let currentChordIndex = 0;
            let chordProgression = [2, 3, 4, 1]; // Indices of chords array

            // --- Audio Engine Setup ---

            async function initAudio() {
                if (audioCtx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();

                // Master Chain
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.5;

                // Compressor to glue it together
                compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -20;
                compressor.knee.value = 30;
                compressor.ratio.value = 12;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;

                // Analyser for visualizer
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;

                // Connect Chain
                masterGain.connect(compressor);
                compressor.connect(analyser);
                analyser.connect(audioCtx.destination);

                // Mixer Nodes (for instant muting)
                mixKick = audioCtx.createGain();
                mixSnare = audioCtx.createGain();
                mixHihat = audioCtx.createGain();
                mixChord = audioCtx.createGain();

                mixKick.connect(masterGain);
                mixSnare.connect(masterGain);
                mixHihat.connect(masterGain);
                mixChord.connect(masterGain);

                // Initialize volume based on state
                mixKick.gain.value = instrumentState.kick ? instrumentVolumes.kick : 0;
                mixSnare.gain.value = instrumentState.snare ? instrumentVolumes.snare : 0;
                mixHihat.gain.value = instrumentState.hihat ? instrumentVolumes.hihat : 0;
                mixChord.gain.value = instrumentState.chord ? instrumentVolumes.chord * 0.7 : 0;

                // Start ambiance
                createVinylCrackle();

                // Start Visualizer
                drawVisualizer();
            }

            // --- Instruments ---

            function createKick(time) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.connect(gain);
                gain.connect(mixKick);

                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);

                gain.gain.setValueAtTime(1, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);

                osc.start(time);
                osc.stop(time + 0.5);

                // Slight visual bump
                const icon = document.querySelector('[data-lucide="play"]');
                if (icon && isPlaying) {
                    // Trigger simple CSS animation logic if needed, 
                    // but we'll rely on the visualizer mostly.
                }
            }

            function createSnare(time) {
                // Noise burst
                const bufferSize = audioCtx.sampleRate * 0.5; // 0.5s
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const noiseFilter = audioCtx.createBiquadFilter();
                noiseFilter.type = 'highpass';
                noiseFilter.frequency.value = 1000;
                const noiseGain = audioCtx.createGain();

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(mixSnare);

                noiseGain.gain.setValueAtTime(0.4, time);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
                noise.start(time);

                // Triangle "tone" underneath
                const osc = audioCtx.createOscillator();
                osc.type = 'triangle';
                const oscGain = audioCtx.createGain();
                osc.connect(oscGain);
                oscGain.connect(mixSnare);

                osc.frequency.setValueAtTime(200, time);
                oscGain.gain.setValueAtTime(0.2, time);
                oscGain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);

                osc.start(time);
                osc.stop(time + 0.2);
            }

            function createHiHat(time) {
                const bufferSize = audioCtx.sampleRate * 0.1;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;

                const bandpass = audioCtx.createBiquadFilter();
                bandpass.type = 'bandpass';
                bandpass.frequency.value = 10000;

                const highpass = audioCtx.createBiquadFilter();
                highpass.type = 'highpass';
                highpass.frequency.value = 5000; // Lowered to let some "meat" through for crunch

                const distortion = audioCtx.createWaveShaper();
                distortion.curve = makeDistortionCurve(100);
                distortion.oversample = '4x';

                const gain = audioCtx.createGain();

                noise.connect(bandpass);
                bandpass.connect(highpass);
                highpass.connect(distortion);
                distortion.connect(gain);
                gain.connect(mixHihat);

                // Sharper, crunchier hit (increased baseline)
                const velocity = 0.15 + Math.random() * 0.1;

                gain.gain.setValueAtTime(velocity, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1); // Slightly longer for "sizzle"
                noise.start(time);
                noise.stop(time + 0.1);
            }

            function playChord(time, duration) {
                if (!instrumentState.chord) return;

                // Pick next chord in progression
                const chordObj = chords[chordProgression[currentChordIndex % chordProgression.length]];
                currentChordIndex++;

                // Visual Update
                setTimeout(() => {
                    if (isPlaying) chordDisplay.innerText = chordObj.name;
                }, (time - audioCtx.currentTime) * 1000);

                // Create nodes for polyphony
                const chordGain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();

                // Lofi Filter settings (controlled by slider)
                filter.type = 'lowpass';
                filter.frequency.value = parseInt(filterSlider.value);
                filter.Q.value = 1;

                // Tape Wobble (LFO)
                const lfo = audioCtx.createOscillator();
                const lfoGain = audioCtx.createGain();
                lfo.type = 'sine';
                lfo.frequency.value = 0.5 + Math.random(); // Slow wobble
                lfoGain.gain.value = parseInt(wobbleSlider.value); // Wobble depth

                lfo.connect(lfoGain);

                chordGain.connect(filter);
                filter.connect(mixChord);

                if (!chordObj || !chordObj.offsets) {
                    console.error("Invalid chord object:", chordObj);
                    return;
                }

                chordObj.offsets.forEach(midiNote => {
                    const osc = audioCtx.createOscillator();
                    osc.type = Math.random() > 0.5 ? 'triangle' : 'sine'; // Mix waveforms

                    // Midi to Freq conversion
                    const freq = 440 * Math.pow(2, (midiNote - 69) / 12);
                    osc.frequency.value = freq;

                    // Connect LFO to detune for wobble
                    lfoGain.connect(osc.detune);

                    // Envelope
                    const noteGain = audioCtx.createGain();
                    noteGain.gain.value = 0.15 / chordObj.offsets.length; // Normalize volume

                    osc.connect(noteGain);
                    noteGain.connect(chordGain);

                    osc.start(time);
                    osc.stop(time + duration);

                    // ADSR-ish
                    noteGain.gain.setValueAtTime(0, time);
                    noteGain.gain.linearRampToValueAtTime(0.08, time + 0.1); // Attack
                    noteGain.gain.linearRampToValueAtTime(0.05, time + 0.3); // Decay
                    noteGain.gain.setValueAtTime(0.05, time + duration - 0.5); // Sustain
                    noteGain.gain.linearRampToValueAtTime(0, time + duration); // Release
                });

                lfo.start(time);
                lfo.stop(time + duration);
            }

            function createVinylCrackle() {
                // Buffer size of 2 seconds
                const bufferSize = audioCtx.sampleRate * 2;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);

                // Pink-ish noise generation
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    // Simple Brown/Pink filter
                    const out = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = out;
                    data[i] = out * 3.5; // boost level

                    // Add random "pops"
                    if (Math.random() > 0.9995) {
                        data[i] = (Math.random() * 2 - 1) * 0.8;
                    }
                }

                vinylNode = audioCtx.createBufferSource();
                vinylNode.buffer = buffer;
                vinylNode.loop = true;

                vinylGain = audioCtx.createGain();
                const crackleVol = parseInt(crackleSlider.value) / 500; // scaling
                vinylGain.gain.value = isPlaying ? crackleVol : 0;

                vinylNode.connect(vinylGain);
                vinylGain.connect(masterGain);
                vinylNode.start();
            }

            // --- Scheduler ---

            function scheduleNote(beatNumber, time) {
                // Humanize rhythm slightly (swing/drunk)
                const swing = (beatNumber % 2 === 1) ? 0.05 : 0;
                const humanize = (Math.random() - 0.5) * 0.02;
                const triggerTime = time + swing + humanize;

                // Drums Pattern (Simple Boom Bap)
                // 0: Kick
                // 1: Hihat
                // 2: Snare + Hihat
                // 3: Hihat
                // 4: Kick + Kick Ghost
                // 5: Hihat
                // 6: Snare
                // 7: Hihat

                // Pattern Branching based on Station Style
                const style = stations[currentStation].style;

                if (style === "classic") {
                    // Classic Boom Bap (Current pattern)
                    if (beatNumber % 8 === 0 && instrumentState.kick) createKick(triggerTime);
                    if (beatNumber % 8 === 4 && instrumentState.kick) createKick(triggerTime);
                    if ((beatNumber % 8 === 2 || beatNumber % 8 === 6) && instrumentState.snare) createSnare(triggerTime);
                    if (instrumentState.hihat) createHiHat(triggerTime);
                    if (Math.random() > 0.8 && instrumentState.hihat) createHiHat(triggerTime + ((60 / bpm) / 4));
                } else if (style === "minimal") {
                    // Minimal/Lo-fi ambient (Fewer kicks, softer)
                    if (beatNumber % 8 === 0 && instrumentState.kick) createKick(triggerTime);
                    if (beatNumber % 8 === 6 && instrumentState.snare) createSnare(triggerTime);
                    if (beatNumber % 2 === 0 && instrumentState.hihat) createHiHat(triggerTime);
                } else if (style === "jazzy") {
                    // Jazzy/Swingy (More ghosts, syncopation)
                    if (beatNumber % 8 === 0 && instrumentState.kick) createKick(triggerTime);
                    if (beatNumber % 8 === 3 && Math.random() > 0.5 && instrumentState.kick) createKick(triggerTime);
                    if (beatNumber % 8 === 4 && instrumentState.kick) createKick(triggerTime);
                    if ((beatNumber % 8 === 2 || beatNumber % 8 === 6) && instrumentState.snare) createSnare(triggerTime);
                    if (instrumentState.hihat) createHiHat(triggerTime);
                    // Double hats on 1st and 3rd beats
                    if (beatNumber % 4 === 0 && instrumentState.hihat) createHiHat(triggerTime + ((60 / bpm) / 4));
                }

                // Global Chord Logic (applies to all stations)
                if (beatNumber % 16 === 0) {
                    if (Math.random() > 0.7) {
                        chordProgression = chordProgression.sort(() => Math.random() - 0.5);
                    }
                    if (instrumentState.chord) playChord(triggerTime, (60 / bpm) * 16);
                }

                // Occasional ghost kick (mostly for classic/jazzy)
                if (style !== 'minimal' && beatNumber % 8 === 3 && Math.random() > 0.7 && instrumentState.kick) {
                    createKick(triggerTime + 0.2);
                }
            }

            function nextNote() {
                const secondsPerBeat = 60.0 / bpm;
                // We are scheduling 8th notes
                nextNoteTime += 0.5 * secondsPerBeat;
                beatCount++;
            }

            function scheduler() {
                while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                    scheduleNote(beatCount, nextNoteTime);
                    nextNote();
                }
                if (isPlaying) {
                    timerID = requestAnimationFrame(scheduler);
                }
            }

            // --- Visualizer ---

            function drawVisualizer() {
                requestAnimationFrame(drawVisualizer);

                if (!analyser) return;

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                // Resize canvas if needed
                if (canvas.width !== canvas.offsetWidth) {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                }

                const width = canvas.width;
                const height = canvas.height;

                canvasCtx.clearRect(0, 0, width, height);

                // Draw "Wave" style
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = 'rgba(217, 119, 6, 0.8)'; // Amber-600
                canvasCtx.beginPath();

                const sliceWidth = width * 1.0 / bufferLength;
                let x = 0;

                // Only draw lower frequencies mainly
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = height - (v * height / 1.5); // scaling

                    if (i === 0) canvasCtx.moveTo(x, y);
                    else canvasCtx.lineTo(x, y);

                    x += sliceWidth;
                }

                canvasCtx.stroke();
            }

            // --- UI Interactions ---

            playBtn.addEventListener('click', async () => {
                if (!isPlaying) {
                    await initAudio();

                    // Reset time if needed to prevent mass catchup
                    if (audioCtx.state === 'suspended') await audioCtx.resume();
                    nextNoteTime = audioCtx.currentTime + 0.1;
                    beatCount = 0;

                    isPlaying = true;
                    scheduler();

                    // Update UI
                    playBtn.classList.add('playing');
                    statusText.innerText = "PLAYING...";
                    statusText.classList.remove('animate-pulse');
                    tapeWheels.classList.remove('opacity-0');

                    // Restore volume
                    masterGain.gain.setTargetAtTime(0.5, audioCtx.currentTime, 0.1);

                    // Enable vinyl
                    if (vinylGain) vinylGain.gain.setValueAtTime(parseInt(crackleSlider.value) / 500, audioCtx.currentTime);

                } else {
                    isPlaying = false;
                    window.cancelAnimationFrame(timerID);

                    // Silence master
                    masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);

                    // Update UI
                    playBtn.classList.remove('playing');
                    statusText.innerText = "PAUSED";
                    statusText.classList.add('animate-pulse');
                    tapeWheels.classList.add('opacity-0');

                    // Silence vinyl
                    if (vinylGain) vinylGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
                }
            });

            // Sliders
            filterSlider.addEventListener('input', (e) => {
                document.getElementById('filter-val').innerText = e.target.value + "Hz";
                // The value is read dynamically in playChord
            });

            crackleSlider.addEventListener('input', (e) => {
                const val = e.target.value;
                document.getElementById('crackle-val').innerText = val + "%";
                if (vinylGain && isPlaying) {
                    vinylGain.gain.setTargetAtTime(val / 500, audioCtx.currentTime, 0.1);
                }
            });

            wobbleSlider.addEventListener('input', (e) => {
                const val = e.target.value;
                let label = "Low";
                if (val > 20) label = "Med";
                if (val > 40) label = "High";
                document.getElementById('wobble-val').innerText = label;
            });

            // Help System
            const helpData = {
                filter: {
                    title: "Lofi Filter",
                    desc: "Cuts out high frequencies to create a warm, muffled sound. It mimics the limited frequency response of old radios or tape recorders.",
                    impl: "Uses a <code>BiquadFilterNode</code> with type <code>lowpass</code>. The slider controls the <code>frequency</code> parameter from 100Hz to 3000Hz."
                },
                crackle: {
                    title: "Vinyl Crackle",
                    desc: "Adds a layer of background noise with occasional pops and clicks, characteristic of aged vinyl records.",
                    impl: "Uses a custom <code>AudioBuffer</code> filled with White Noise. Randomly injected spikes in the data buffer create the 'pops'."
                },
                wobble: {
                    title: "Tape Wobble",
                    desc: "Creates subtle pitch fluctuations (Wow & Flutter) found in imperfect analog tape decks.",
                    impl: "Uses a Low-Frequency Oscillator (LFO) connected to the <code>detune</code> parameter of each sound source. The slider controls the <code>gain</code> (depth) of the LFO."
                },
                chord: {
                    title: "Chord Synthesis",
                    desc: "The current musical chord being generated. Each chord is a collection of harmonically related notes that define the song's 'vibe'.",
                    impl: "Picks a progression from a library of jazz-theory MIDI offsets. Each note is synthesized using polyphonic oscillators with random waveform mixing (Sine/Triangle) and an ADSR-ish gain envelope."
                }
            };

            function showHelp(key) {
                const data = helpData[key];
                document.getElementById('help-title').innerText = data.title;
                document.getElementById('help-content').innerHTML = `
                <div>
                    <h4 class="text-amber-600/70 uppercase text-[10px] font-black mb-1 leading-tight">Effect</h4>
                    <p>${data.desc}</p>
                </div>
                <div class="pt-2">
                    <h4 class="text-amber-600/70 uppercase text-[10px] font-black mb-1 leading-tight">Implementation</h4>
                    <p>${data.impl}</p>
                </div>
            `;
                document.getElementById('help-modal').classList.remove('hidden');
            }

            function hideHelp() {
                document.getElementById('help-modal').classList.add('hidden');
            }

            // Close modal on escape
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideHelp();
            });

            // Close on background click
            document.getElementById('help-modal').addEventListener('click', (e) => {
                if (e.target.id === 'help-modal') hideHelp();
            });

            // Station Switching
            function switchStation(id) {
                currentStation = id;
                const data = stations[id];
                bpm = data.bpm;

                // Update UI buttons
                document.querySelectorAll('.station-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${id}`).classList.add('active');

                // Visual Feedback on Screen
                const status = document.getElementById('status-text');
                const oldText = status.innerText;
                status.innerText = data.name.toUpperCase();
                status.classList.remove('animate-pulse');

                // Color chord display
                const display = document.getElementById('chord-display');
                display.className = `text-sm h-5 font-mono transition-colors duration-500 ${data.color}`;

                setTimeout(() => {
                    status.innerText = isPlaying ? "PLAYING..." : "READY...";
                    if (!isPlaying) status.classList.add('animate-pulse');
                }, 2000);
            }

            // Mixer Logic
            function updateMixerVolume(name, value) {
                const vol = value / 100;
                instrumentVolumes[name] = vol;
                if (instrumentState[name]) {
                    const nodes = {
                        kick: mixKick,
                        snare: mixSnare,
                        hihat: mixHihat,
                        chord: mixChord
                    };
                    const targetGain = name === 'chord' ? vol * 0.7 : vol;
                    if (nodes[name]) {
                        nodes[name].gain.setTargetAtTime(targetGain, audioCtx.currentTime, 0.05);
                    }
                }
            }

            function toggleInstrument(name) {
                instrumentState[name] = !instrumentState[name];
                const btn = document.getElementById(`mix-${name}`);

                // Audio Routing Gain Nodes
                const nodes = {
                    kick: mixKick,
                    snare: mixSnare,
                    hihat: mixHihat,
                    chord: mixChord
                };

                const vol = instrumentVolumes[name];
                const targetGain = instrumentState[name] ? (name === 'chord' ? vol * 0.7 : vol) : 0;

                if (nodes[name]) {
                    nodes[name].gain.setTargetAtTime(targetGain, audioCtx.currentTime, 0.02);
                }

                if (instrumentState[name]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                    // If mutes chords, clear the display shortly after
                    if (name === 'chord') {
                        setTimeout(() => {
                            if (!instrumentState.chord) chordDisplay.innerText = "--";
                        }, 50);
                    }
                }
            }

            function makeDistortionCurve(amount) {
                const k = typeof amount === 'number' ? amount : 50;
                const n_samples = 44100;
                const curve = new Float32Array(n_samples);
                const deg = Math.PI / 180;
                for (let i = 0; i < n_samples; ++i) {
                    const x = (i * 2) / n_samples - 1;
                    curve[i] = ((3 + k) * x * 20 * deg) / (Math.PI + k * Math.abs(x));
                }
                return curve;
            }

        </script>
</body>

</html>